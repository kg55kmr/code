<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/fotorama/fotorama.css">
    <link href="https://fonts.googleapis.com/css?family=Forum" rel="stylesheet">
    <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/jquery"></script>
    <script src="https://unpkg.com/fotorama/fotorama.js"></script>
    <script src="https://cdn.rawgit.com/kzh55/kzh55/c640cf83/src/app/js/flickr.js"></script>
</head>
<body>
    <div id="posts-mount">
        <ul id="posts">
            <li class="post" v-for="post, index in posts" @click="postClick(post, index)">
                <div class="ltr">
                    <div class="thumbnail"><img :src="post.thumbnail" onerror="emptyThumb(this)"></div>
                    <div class="info">
                        <div class="date">{{ post.date }}</div>
                        <div class="title">{{ post.title }}</div>
                    </div>
                </div>
                <div class="content" :class="isSelected(post)" v-html="post.content" @click.stop=""></div>
            </li>
        </ul>
        <ul id="pagination">
            <li class="page" v-for="page in pages" @click="pageClick(page.index)" :class="isActive(page.index)">{{ page.index + 1 }}</li>
        </ul>
    </div>
    <script>
        let vue = new Vue({
            el: '#posts-mount',
            data: {
                posts: [],
                pages: [],
                selected: null,
                pageActive: 0
            },
            methods: {
                postClick(post, index) {
                    if (this.selected === post) this.selected = null;
                    else {
                        this.selected = post;

                        const scriptId = `script_${index}`;
                        if (document.getElementById(scriptId) == null) {
                            let script = document.createElement('script');
                            script.id = `script_${index}`;
                            script.innerHTML = post.script;
                            document.getElementById('posts').appendChild(script);
                        }
                    }
                },
                pageClick(page) {
                    if (this.pageActive == page) return;

                    this.pageActive = page;
                    this.posts = this.pages[page].posts;
                },
                isSelected(post) {
                    return {
                        expand: post === this.selected
                    }
                },
                isActive(page) {
                    return {
                        active: this.pageActive === page
                    }
                }
            },
            async mounted() {
                let query = new URLSearchParams(window.location.search);
                let r = await axios.get(`https://kzh55.github.io/tags/${query.get('from')}/index.json`);
                for (let post of r.data) {
                    let d = new Date(post.date);
                    post.date = ('0' + d.getDate()).slice(-2) + '/' + ('0' + (d.getMonth() + 1)).slice(-2) + '/' + d.getFullYear();

                    let reScript = /<script>([\s\S]*?)<\/script>/g;
                    post.script = '';
                    let m;

                    while ((m = reScript.exec(post.content)) !== null) {
                        if (m.index === reScript.lastIndex) reScript.lastIndex++;
                        post.script += m[1];
                    }
                }

                let pageTotal = Math.ceil(r.data.length / 5);
                for (let i = 0; i < pageTotal; i++) {
                    let from = i * 5;
                    let to = from + 5;
                    if (to >= r.data.length) to = r.data.length;

                    let page = {
                        index: i,
                        posts: r.data.slice(from, to)
                    };
                    this.pages.push(page);
                }
                this.posts = this.pages[0].posts;
            }
        });
        function emptyThumb(o) {
            $(o).attr('src', 'https://kzh55.github.io/thumbnails/empty.jpg');
        }
    </script>
</body>
</html>